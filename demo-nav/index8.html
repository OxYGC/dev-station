<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Web3 Nav</title>

    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",sans-serif;
            min-height:100vh;
            padding:20px;
            color:#0f172a;
            position:relative;
        }
        body::before{
            content:"";
            position:fixed;
            inset:0;
            z-index:-1;
            background:linear-gradient(120deg,#6366f1,#22d3ee,#a78bfa,#6366f1);
            background-size:300% 300%;
            animation:gradient 18s ease infinite;
        }
        @keyframes gradient{
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }
        .container{max-width:1200px;margin:auto}
        .toolbar,.group{
            background:rgba(255,255,255,.75);
            backdrop-filter:blur(14px);
            border-radius:14px;
        }
        .toolbar{
            padding:14px;
            display:flex;
            align-items:center;
            gap:12px;
            margin-bottom:20px;
        }
        .toolbar h1{font-size:22px}
        .search{
            flex:1;
            max-width:220px;
            padding:6px 10px;
            border-radius:8px;
            border:1px solid rgba(0,0,0,.1);
        }
        .group{margin-bottom:18px}
        .group-header{
            padding:12px 16px;
            font-weight:600;
            cursor:grab;
        }
        .cards{
            padding:12px;
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
            gap:10px;
            min-height:80px;
        }
        .card{
            display:flex;
            gap:10px;
            padding:10px;
            border-radius:10px;
            background:rgba(255,255,255,.9);
            cursor:grab;
        }
        .card.dragging{opacity:.5}
        .ico{width:36px;height:36px;border-radius:8px;background:#eef2ff;display:flex;align-items:center;justify-content:center}
        .ico img{width:100%;height:100%;object-fit:contain}
        .info h3{font-size:14px}
        .info p{font-size:12px;color:#64748b}
        .hidden{display:none}
        footer{margin-top:40px;text-align:center;font-size:13px;color:#e5e7eb}
    </style>
</head>

<body>
<div class="container">
    <div class="toolbar">
        <h1 id="title"></h1>
        <input id="search" class="search" placeholder="搜索站点（/）"/>
    </div>
    <div id="groups"></div>
    <footer id="footer"></footer>
</div>

<script>
    /* ================= 常量 ================= */
    const STORAGE_KEY = 'nav_site_data_v2';
    const GROUP_ORDER_KEY = 'nav_group_order';
    const DEFAULT_CONF_URL =
        'https://raw.githubusercontent.com/OxYGC/dev-station/refs/heads/main/demo-nav/data/default-conf.json';

    let state = {
        config:{},
        categoryList:[],
        data:[]
    };

    /* ================= 工具 ================= */
    const $ = id => document.getElementById(id);
    const save = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        localStorage.setItem(
            GROUP_ORDER_KEY,
            JSON.stringify(state.categoryList.map(c=>c.id))
        );
    };
    const autoLogo = url => {
        try {
            return `https://www.google.com/s2/favicons?sz=64&domain=${new URL(url).hostname}`;
        } catch { return '' }
    };

    /* ================= 初始化（重点修复） ================= */
    async function init(){
        const local = localStorage.getItem(STORAGE_KEY);
        if(local){
            state = JSON.parse(local);
            applyGroupOrder();
            render();
            return;
        }

        const conf = await fetch(DEFAULT_CONF_URL).then(r=>r.json());
        state.config = conf.config || {};

        if(conf.api && conf.api.homeUrl){
            const remote = await fetch(conf.api.homeUrl).then(r=>r.json());
            state.categoryList = normalizeCategory(remote.categoryList || []);
            state.data = normalizeData(remote.data || []);
        }

        save();
        render();
    }

    function normalizeCategory(list){
        const seen = new Set();
        return list.filter(c=>{
            if(seen.has(c.id)) return false;
            seen.add(c.id);
            return true;
        });
    }
    function normalizeData(list){
        const seen = new Set();
        return list.filter(i=>{
            if(seen.has(i.id)) return false;
            seen.add(i.id);
            return true;
        });
    }

    function applyGroupOrder(){
        const order = JSON.parse(localStorage.getItem(GROUP_ORDER_KEY) || '[]');
        if(order.length){
            state.categoryList.sort(
                (a,b)=>order.indexOf(a.id)-order.indexOf(b.id)
            );
        }
    }

    /* ================= 渲染 ================= */
    function render(){
        $('title').innerText = state.config.title || '导航站点';
        $('footer').innerHTML =
            (state.config.footerText||'')
                .replace('{CURRENT_YEAR}',new Date().getFullYear());

        const box = $('groups');
        box.innerHTML = '';

        state.categoryList.forEach(cat=>{
            const items = state.data.filter(i=>i.categoryId===cat.id);
            const g = document.createElement('div');
            g.className='group';
            g.innerHTML = `
      <div class="group-header">${cat.name} (${items.length})</div>
      <div class="cards"></div>
    `;
            const cards = g.querySelector('.cards');

            items.forEach(i=>{
                const c = document.createElement('div');
                c.className='card';
                c.innerHTML=`
        <div class="ico"><img src="${i.logoUrl||autoLogo(i.url)}"></div>
        <div class="info">
          <h3>${i.name}</h3>
          <p>${i.desc||i.url}</p>
        </div>
      `;
                cards.appendChild(c);
            });

            box.appendChild(g);
        });
    }

    /* ================= 搜索 ================= */
    $('search').oninput = e=>{
        const q = e.target.value.toLowerCase();
        document.querySelectorAll('.group').forEach(g=>{
            let hit=false;
            g.querySelectorAll('.card').forEach(c=>{
                const ok = c.innerText.toLowerCase().includes(q);
                c.classList.toggle('hidden',!ok);
                if(ok) hit=true;
            });
            g.classList.toggle('hidden',!hit);
        });
    };

    document.addEventListener('keydown',e=>{
        if(e.key==='/'){e.preventDefault();$('search').focus()}
    });

    init();
</script>
</body>
</html>