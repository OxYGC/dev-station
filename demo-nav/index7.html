<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Nav-site</title>

    <style>
        *{margin:0;padding:0;box-sizing:border-box}

        /* ===== gradient.style 风格流动背景 ===== */
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",sans-serif;
            min-height:100vh;
            color:#1e293b;
            padding:20px;
            position:relative;
            overflow-x:hidden;
        }
        body::before{
            content:"";
            position:fixed;
            inset:0;
            z-index:-1;
            background:linear-gradient(
                    120deg,
                    #6366f1,
                    #22d3ee,
                    #a78bfa,
                    #6366f1
            );
            background-size:300% 300%;
            animation:gradientMove 18s ease infinite;
        }
        @keyframes gradientMove{
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }

        .container{max-width:1100px;margin:auto}
        .hidden{display:none}

        /* ===== 毛玻璃容器 ===== */
        .toolbar,.group{
            background:rgba(255,255,255,.75);
            backdrop-filter:blur(14px);
            -webkit-backdrop-filter:blur(14px);
            border-radius:12px;
        }

        /* Toolbar */
        .toolbar{
            display:flex;
            gap:10px;
            align-items:center;
            padding:12px 14px;
            margin-bottom:20px;
        }
        .toolbar h1{font-size:22px}
        .search{
            flex:1;
            max-width:240px;
            padding:8px 12px;
            border-radius:8px;
            border:1px solid rgba(0,0,0,.1);
            background:rgba(255,255,255,.6);
        }

        /* Buttons */
        .btn{padding:6px 12px;border-radius:6px;border:none;cursor:pointer}
        .btn-outline{background:rgba(255,255,255,.8);border:1px solid rgba(0,0,0,.1)}

        /* Group */
        .group{
            margin-bottom:20px;
            box-shadow:0 10px 30px rgba(0,0,0,.08);
        }
        .group-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 16px;
            cursor:grab;
            user-select:none;
        }
        .group-header.dragging{opacity:.5}
        .group-title{font-weight:600}

        .cards{
            padding:14px;
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
            gap:10px;
            min-height:80px;
        }
        .cards.drag-over{
            outline:2px dashed #6366f1;
            border-radius:10px;
        }

        /* Card */
        .card{
            display:flex;
            align-items:center;
            gap:10px;
            padding:8px 10px;
            border-radius:10px;
            background:rgba(255,255,255,.9);
            box-shadow:0 2px 6px rgba(0,0,0,.08);
            cursor:grab;
        }
        .card.dragging{opacity:.5}
        .ico{width:36px;height:36px;border-radius:6px;background:#eef2ff;display:flex;align-items:center;justify-content:center}
        .ico img{width:100%;height:100%;object-fit:contain}
        .info{flex:1;min-width:0}
        .info h3{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .info p{font-size:12px;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    </style>
</head>

<body>
<div class="container">

    <div class="toolbar">
        <h1 id="title">导航站点</h1>
        <input id="search" class="search" placeholder="搜索站点 / URL（/ 或 Ctrl+K）"/>
        <button class="btn btn-outline" id="addGroup">+ 新建类型分组</button>
    </div>

    <div id="groups"></div>

    <footer id="footer" style="margin-top:40px;text-align:center;color:#e5e7eb;font-size:13px"></footer>

</div>

<script>
    /* ================= 配置 ================= */
    const STORAGE_KEY='nav_site_data_v2';
    const GROUP_ORDER_KEY='nav_group_order';
    const DEFAULT_CONF='https://raw.githubusercontent.com/OxYGC/dev-station/refs/heads/main/demo-nav/data/default-conf.json';

    let state={config:{},categoryList:[],data:[]};

    /* ================= 工具 ================= */
    const $=id=>document.getElementById(id);
    const save=()=>{
        localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
        localStorage.setItem(GROUP_ORDER_KEY,JSON.stringify(state.categoryList.map(c=>c.id)));
    };
    const autoLogo=url=>{
        try{return `https://www.google.com/s2/favicons?sz=64&domain=${new URL(url).hostname}`}
        catch{return ''}
    };
    const normalizeData=()=>{
        const seenCat=new Set();
        state.categoryList=state.categoryList.filter(c=>{
            if(seenCat.has(c.id)) return false;
            seenCat.add(c.id);
            return true;
        });
        const seenItem=new Set();
        state.data=state.data.filter(i=>{
            if(seenItem.has(i.id)) return false;
            seenItem.add(i.id);
            return true;
        });
        state.categoryList.forEach(c=>{
            const items=state.data.filter(i=>i.categoryId===c.id);
            items.sort((a,b)=>(a.weight||0)-(b.weight||0))
                .forEach((it,idx)=>it.weight=idx+1);
        });
    };

    /* ================= 初始化 ================= */
    async function init(){
        const local=localStorage.getItem(STORAGE_KEY);
        if(local){
            state=JSON.parse(local);
        }else{
            const conf=await fetch(DEFAULT_CONF).then(r=>r.json());
            state.config=conf.config||{};
            const remote=await fetch(conf.api.homeUrl).then(r=>r.json());
            state.categoryList=remote.categoryList||[];
            state.data=remote.data||[];
            normalizeData();
            save();
        }
        render();
    }

    /* ================= 渲染 ================= */
    function render(){
        $('title').innerText=state.config.title||'导航站点';
        $('footer').innerHTML=(state.config.footerText||'')
            .replace('{CURRENT_YEAR}',new Date().getFullYear());

        const box=$('groups'); box.innerHTML='';
        state.categoryList.forEach(cat=>{
            const items=state.data.filter(d=>d.categoryId===cat.id);

            const g=document.createElement('div');
            g.className='group';

            g.innerHTML=`
<div class="group-header" draggable="true" data-id="${cat.id}">
  <div class="group-title">${cat.name} (${items.length})</div>
  <button class="btn btn-outline" onclick="addItem(${cat.id})">+ 站点</button>
</div>
<div class="cards" data-id="${cat.id}"></div>
`;
            const header=g.querySelector('.group-header');
            const cards=g.querySelector('.cards');

            header.ondragstart=e=>{
                header.classList.add('dragging');
                e.dataTransfer.setData('group',cat.id);
            };
            header.ondragend=()=>{
                header.classList.remove('dragging');
                const ids=[...document.querySelectorAll('.group-header')]
                    .map(h=>+h.dataset.id);
                state.categoryList.sort((a,b)=>ids.indexOf(a.id)-ids.indexOf(b.id));
                save();
            };
            header.ondragover=e=>{
                e.preventDefault();
                const dragging=document.querySelector('.group-header.dragging');
                if(dragging && dragging!==header){
                    header.parentNode.before(dragging.parentNode);
                }
            };

            items.forEach(i=>{
                const c=document.createElement('div');
                c.className='card';
                c.draggable=true;
                c.dataset.id=i.id;
                c.innerHTML=`
<div class="ico"><img src="${i.logoUrl||autoLogo(i.url)}"></div>
<div class="info">
  <h3>${i.name}</h3>
  <p>${i.url}</p>
</div>
`;
                c.ondragstart=()=>c.classList.add('dragging');
                c.ondragend=()=>{
                    c.classList.remove('dragging');
                    document.querySelectorAll('.cards').forEach(box=>{
                        const cid=+box.dataset.id;
                        [...box.children].forEach((el,idx)=>{
                            const item=state.data.find(d=>d.id==el.dataset.id);
                            if(item){
                                item.categoryId=cid;
                                item.weight=idx+1;
                            }
                        });
                    });
                    save();
                };
                cards.appendChild(c);
            });

            cards.ondragover=e=>{
                e.preventDefault();
                const dragging=document.querySelector('.card.dragging');
                if(dragging){
                    const after=[...cards.children]
                        .find(el=>e.clientY<el.getBoundingClientRect().top+el.offsetHeight/2);
                    cards.insertBefore(dragging,after||null);
                }
            };

            box.appendChild(g);
        });
    }

    /* ================= 新增站点（修复） ================= */
    async function addItem(cid){
        let url='';
        try{
            url=(await navigator.clipboard.readText()).trim();
        }catch{}
        if(!/^https?:\/\//.test(url)){
            url=prompt('请输入站点 URL');
        }
        if(!/^https?:\/\//.test(url)) return;

        if(state.data.some(i=>i.url===url)) return;

        const u=new URL(url);
        state.data.push({
            id:Date.now(),
            categoryId:cid,
            name:u.hostname.replace('www.',''),
            desc:'',
            url,
            logoUrl:autoLogo(url),
            weight:state.data.filter(i=>i.categoryId===cid).length+1,
            date:new Date().toISOString()
        });
        save();render();
    }

    /* ================= 搜索 ================= */
    $('search').oninput=e=>{
        const q=e.target.value.toLowerCase();
        document.querySelectorAll('.group').forEach(g=>{
            let hit=false;
            g.querySelectorAll('.card').forEach(c=>{
                const ok=c.innerText.toLowerCase().includes(q);
                c.classList.toggle('hidden',!ok);
                if(ok) hit=true;
            });
            g.classList.toggle('hidden',!hit);
        });
    };

    /* ================= 快捷键 ================= */
    document.addEventListener('keydown',e=>{
        if(e.key==='/'||((e.ctrlKey||e.metaKey)&&e.key==='k')){
            e.preventDefault();$('search').focus();
        }
        if(e.key==='Escape'){
            $('search').value='';
            $('search').dispatchEvent(new Event('input'));
        }
    });

    init();
</script>
</body>
</html>