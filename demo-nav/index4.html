<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æ™ºèƒ½å¯¼èˆªç®¡ç†å™¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body {
            background-color: #f8fafc;
            padding: 20px;
            color: #1e293b;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 10px;
        }
        .btn {
            padding: 6px 12px;
            border: 1px solid #cbd5e1;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn:hover {
            background: #f1f5f9;
        }
        .btn-success {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }
        .btn-success:hover {
            background: #0284c7;
        }
        .category {
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .category-header {
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 18px;
        }
        .site-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        .site-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            background: #fff;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }
        .site-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .site-logo {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin-right: 8px;
            object-fit: contain;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }

        /* Logo é¢„è§ˆ */
        .preview-logo {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background-color: #f1f5f9;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            vertical-align: middle;
        }
        .preview-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .preview-logo.loading::after {
            content: "â€¦";
            color: #94a3b8;
            font-size: 14px;
        }

        /* æ‹–æ‹½æç¤º */
        body.dragging-over {
            background-color: #e0f2fe !important;
            outline: 3px dashed #38bdf8;
            outline-offset: -10px;
        }
        .drag-hint {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .drag-hint.active {
            opacity: 1;
            pointer-events: all;
            background: rgba(255,255,255,0.9);
        }
        .drag-hint .content {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            text-align: center;
            font-size: 18px;
            color: #0c4a6e;
        }
        code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<h1>æ™ºèƒ½å¯¼èˆªç®¡ç†å™¨</h1>

<div class="toolbar">
    <button class="btn btn-success" onclick="openAddModal('default')">+ æ·»åŠ ç«™ç‚¹</button>
    <button class="btn" onclick="exportData()">å¯¼å‡º JSON</button>
</div>

<div id="app"></div>

<!-- æ‹–æ‹½æç¤ºå±‚ -->
<div class="drag-hint" id="dragHint">
    <div class="content">ğŸ“ æ‹–å…¥ JSON æ–‡ä»¶å³å¯å¯¼å…¥å¯¼èˆªæ•°æ®</div>
</div>

<script>
    // ======================
    // çŠ¶æ€ç®¡ç†
    // ======================
    let state = {
        config: { version: '1.0' },
        categoryList: [{ id: 'default', name: 'å¸¸ç”¨ç½‘ç«™' }],
        data: []
    };

    // ======================
    // å·¥å…·å‡½æ•°
    // ======================
    function extractDomain(url) {
        try {
            const u = new URL(url);
            return u.hostname.replace(/^www\./, '');
        } catch {
            return '';
        }
    }

    async function getFaviconUrl(targetUrl) {
        const domain = extractDomain(targetUrl);
        if (!domain) return '';

        // å°è¯•åŸç«™ favicon.ico
        const directFavicon = `${new URL(targetUrl).origin}/favicon.ico`;
        try {
            const res = await fetch(directFavicon, { method: 'HEAD' });
            if (res.ok) return directFavicon;
        } catch {}

        // å›é€€åˆ° Google S2
        return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
    }

    function updateLogoPreview(inputId, previewId) {
        const url = document.getElementById(inputId)?.value?.trim();
        const preview = document.getElementById(previewId);
        if (!url || !preview) {
            if (preview) preview.innerHTML = '';
            return;
        }

        preview.className = 'preview-logo loading';
        preview.innerHTML = '';

        getFaviconUrl(url).then(favUrl => {
            if (!favUrl) {
                preview.className = 'preview-logo';
                preview.innerHTML = '';
                return;
            }
            const img = document.createElement('img');
            img.src = favUrl;
            img.onerror = () => { preview.innerHTML = ''; };
            preview.className = 'preview-logo';
            preview.appendChild(img);
        });
    }

    async function fetchPageTitle(url) {
        if (!url) return null;
        try {
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl, { mode: 'cors' });
            const html = await response.text();
            const match = html.match(/<title[^>]*>([^<]+)<\/title>/i);
            return match ? match[1].trim() : null;
        } catch (err) {
            console.warn('Failed to fetch title:', err);
            return null;
        }
    }

    async function autoFetchTitle(urlInputId, descTextareaId) {
        const url = document.getElementById(urlInputId)?.value?.trim();
        if (!url) {
            alert('è¯·å…ˆå¡«å†™æœ‰æ•ˆçš„ URL');
            return;
        }
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'è·å–ä¸­â€¦';

        const title = await fetchPageTitle(url);
        const descEl = document.getElementById(descTextareaId);
        if (title && descEl) {
            descEl.value = title;
            alert(`âœ… å·²è·å–æ ‡é¢˜ï¼š${title.substring(0, 30)}...`);
        } else {
            alert('âš ï¸ æ— æ³•è·å–ç½‘é¡µæ ‡é¢˜ï¼ˆå¯èƒ½è¢«å±è”½æˆ–æ— æ ‡é¢˜ï¼‰');
        }

        btn.disabled = false;
        btn.textContent = 'è‡ªåŠ¨è·å–æ ‡é¢˜';
    }

    function saveToStorage() {
        localStorage.setItem('nav-manager-data', JSON.stringify(state));
    }

    function loadFromStorage() {
        const saved = localStorage.getItem('nav-manager-data');
        if (saved) {
            try {
                Object.assign(state, JSON.parse(saved));
                return true;
            } catch (e) {
                console.error('Load failed', e);
            }
        }
        return false;
    }

    function exportData() {
        const dataStr = JSON.stringify(state, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'nav-data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ======================
    // æ¸²æŸ“
    // ======================
    function renderAll() {
        const app = document.getElementById('app');
        let html = '';

        state.categoryList.forEach(cat => {
            const items = state.data.filter(i => i.categoryId === cat.id);
            if (items.length === 0) return;

            html += `<div class="category">
      <div class="category-header">${cat.name}</div>
      <div class="site-grid">`;

            items.sort((a, b) => a.weight - b.weight).forEach(item => {
                const logo = item.logoUrl
                    ? `<img src="${item.logoUrl}" class="site-logo" onerror="this.style.display='none'">`
                    : `<span style="display:inline-block;width:24px;text-align:center;color:#94a3b8;">${item.name.charAt(0).toUpperCase()}</span>`;
                html += `
        <div class="site-card" onclick="window.open('${item.url}', '_blank')">
          ${logo}
          <strong>${item.name}</strong><br>
          <small style="color:#64748b;">${item.desc || ''}</small>
        </div>`;
            });

            html += `</div></div>`;
        });

        app.innerHTML = html;
    }

    // ======================
    // è¡¨å• & æ‰¹é‡
    // ======================
    function openAddModal(categoryId) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
    <div class="modal-content">
      <h2>æ·»åŠ æ–°ç«™ç‚¹</h2>
      <form id="addItemForm">
        <input type="hidden" id="addItemCategoryId" value="${categoryId}">
        <div class="form-group">
          <label for="addItemName">åç§° *</label>
          <input type="text" id="addItemName" required>
        </div>
        <div class="form-group">
          <label for="addItemUrl">ç½‘å€ (URL) *
            <span id="addItemLogoPreview" class="preview-logo"></span>
          </label>
          <input type="url" id="addItemUrl" required placeholder="https://example.com"
                 oninput="updateLogoPreview('addItemUrl', 'addItemLogoPreview')">
        </div>
        <div class="form-group">
          <label for="addItemDesc">
            æè¿°
            <button type="button" class="btn btn-outline" style="padding:2px 6px;font-size:12px;margin-left:6px;"
                    onclick="autoFetchTitle('addItemUrl', 'addItemDesc')">è‡ªåŠ¨è·å–æ ‡é¢˜</button>
          </label>
          <textarea id="addItemDesc"></textarea>
        </div>
        <div class="form-group">
          <label for="addItemLogoUrl">Logo URLï¼ˆå¯é€‰ï¼‰</label>
          <input type="url" id="addItemLogoUrl" placeholder="https://example.com/favicon.ico">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" onclick="openBatchImportModal('${categoryId}')">æ‰¹é‡å¯¼å…¥</button>
          <button type="button" class="btn btn-outline" onclick="document.body.removeChild(this.closest('.modal'))">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-success">æ·»åŠ </button>
        </div>
      </form>
    </div>
  `;
        document.body.appendChild(modal);

        document.getElementById('addItemForm').onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('addItemName').value.trim();
            const url = document.getElementById('addItemUrl').value.trim();
            const desc = document.getElementById('addItemDesc').value.trim();
            const logoUrl = document.getElementById('addItemLogoUrl').value.trim() ||
                document.getElementById('addItemLogoPreview').querySelector('img')?.src || '';

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;

            state.data.push({
                id: Date.now(),
                categoryId,
                name,
                desc,
                url,
                logoUrl,
                weight: state.data.filter(i => i.categoryId === categoryId).length + 1,
                date: dateStr
            });

            saveToStorage();
            renderAll();
            document.body.removeChild(modal);
        };
    }

    function openBatchImportModal(categoryId) {
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
    <div class="modal-content">
      <h2>æ‰¹é‡å¯¼å…¥ç«™ç‚¹</h2>
      <p>æ¯è¡Œä¸€ä¸ª URLï¼Œä¾‹å¦‚ï¼š<br><code>https://coinmarketcap.com</code></p>
      <div class="form-group">
        <textarea class="url-list" placeholder="https://coinmarketcap.com\nhttps://coingecko.com" required></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline">å–æ¶ˆ</button>
        <button type="button" class="btn btn-success">å¯¼å…¥</button>
      </div>
    </div>
  `;
        document.body.appendChild(modal);

        const textarea = modal.querySelector('textarea');
        const cancelBtn = modal.querySelector('.btn-outline');
        const importBtn = modal.querySelector('.btn-success');

        cancelBtn.onclick = () => document.body.removeChild(modal);
        importBtn.onclick = async () => {
            const urls = textarea.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line && /^https?:\/\//.test(line));

            if (urls.length === 0) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆçš„ URL');
                return;
            }

            const uniqueUrls = [...new Set(urls)];
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;

            for (const url of uniqueUrls) {
                const domain = extractDomain(url) || 'ç«™ç‚¹';
                const logoUrl = await getFaviconUrl(url);
                const title = await fetchPageTitle(url); // å¯é€‰ï¼šä¹Ÿå¯è·³è¿‡ä»¥åŠ å¿«é€Ÿåº¦

                state.data.push({
                    id: Date.now() + Math.random(),
                    categoryId,
                    name: domain,
                    desc: title || url,
                    url,
                    logoUrl,
                    weight: state.data.filter(i => i.categoryId === categoryId).length + 1,
                    date: dateStr
                });
            }

            saveToStorage();
            renderAll();
            document.body.removeChild(modal);
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${uniqueUrls.length} ä¸ªç«™ç‚¹ï¼`);
        };
    }

    // ======================
    // æ‹–æ‹½å¯¼å…¥
    // ======================
    function setupDragImport() {
        const dragHint = document.getElementById('dragHint');
        const body = document.body;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            document.addEventListener(eventName, () => {
                body.classList.add('dragging-over');
                dragHint.classList.add('active');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, () => {
                body.classList.remove('dragging-over');
                dragHint.classList.remove('active');
            }, false);
        });

        document.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length && files[0].name.endsWith('.json')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (imported.categoryList && imported.data) {
                            if (confirm(`ç¡®å®šå¯¼å…¥ ${files[0].name} å¹¶è¦†ç›–å½“å‰æ•°æ®ï¼Ÿ`)) {
                                state = imported;
                                saveToStorage();
                                renderAll();
                                alert('âœ… å¯¼å…¥æˆåŠŸï¼');
                            }
                        } else {
                            alert('âŒ æ–‡ä»¶æ ¼å¼æ— æ•ˆ');
                        }
                    } catch (err) {
                        alert('âŒ è§£æå¤±è´¥ï¼š' + err.message);
                    }
                };
                reader.readAsText(files[0]);
            }
        }, false);
    }

    // ======================
    // åˆå§‹åŒ–
    // ======================
    (async () => {
        if (!loadFromStorage()) {
            // é»˜è®¤ç¤ºä¾‹æ•°æ®
            state.data = [
                { id: 1, categoryId: 'default', name: 'GitHub', url: 'https://github.com', desc: 'ä»£ç æ‰˜ç®¡å¹³å°', logoUrl: 'https://www.google.com/s2/favicons?domain=github.com&sz=64', weight: 1, date: '2026-01-04 12:00:00' },
                { id: 2, categoryId: 'default', name: 'çŸ¥ä¹', url: 'https://zhihu.com', desc: 'ä¸­æ–‡é—®ç­”ç¤¾åŒº', logoUrl: 'https://www.google.com/s2/favicons?domain=zhihu.com&sz=64', weight: 2, date: '2026-01-04 12:00:00' }
            ];
            saveToStorage();
        }
        renderAll();
        setupDragImport();
    })();
</script>

</body>
</html>