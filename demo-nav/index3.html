<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Nav-site</title>

    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",sans-serif;
            min-height:100vh;
            padding:20px;
            color:#0f172a;
        }
        body::before{
            content:"";
            position:fixed;
            inset:0;
            z-index:-1;
            background:linear-gradient(120deg,#6366f1,#22d3ee,#a78bfa,#6366f1);
            background-size:300% 300%;
            animation:gradient 20s ease infinite;
        }
        @keyframes gradient{
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }

        .container{max-width:1200px;margin:auto}

        .toolbar{
            display:flex;
            gap:10px;
            align-items:center;
            padding:14px;
            margin-bottom:20px;
            border-radius:16px;
            background:rgba(255,255,255,.75);
            backdrop-filter:blur(16px);
        }
        .toolbar h1{font-size:22px}
        .toolbar small{opacity:.6}

        .search{
            flex:1;
            max-width:220px;
            padding:6px 10px;
            border-radius:8px;
            border:1px solid #cbd5e1;
        }

        .btn{
            padding:6px 10px;
            border-radius:8px;
            border:1px solid #cbd5e1;
            background:#fff;
            cursor:pointer;
        }

        .group{
            margin-bottom:18px;
            border-radius:16px;
            background:rgba(255,255,255,.78);
            backdrop-filter:blur(14px);
            transition:.2s;
        }
        .group.dragging{opacity:.4}

        .group-header{
            padding:14px 16px;
            font-weight:600;
            cursor:grab;
            display:flex;
            justify-content:space-between;
        }

        .cards{
            padding:12px;
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
            gap:10px;
            min-height:40px;
        }

        .card{
            display:flex;
            gap:10px;
            padding:10px;
            border-radius:12px;
            background:#fff;
            cursor:pointer;
            transition:.15s;
        }
        .card:hover{background:#f1f5f9}
        .card.dragging{opacity:.5}

        .ico{
            width:36px;height:36px;
            border-radius:8px;
            background:#eef2ff;
        }
        .ico img{width:100%;height:100%;object-fit:contain}

        .hidden{display:none}
    </style>
</head>

<body>
<div class="container">

    <div class="toolbar">
        <div>
            <h1 id="title">Nav-site</h1>
            <small id="subtitle"></small>
        </div>
        <input id="search" class="search" placeholder="ÊêúÁ¥¢Á´ôÁÇπ / URLÔºà/Ôºâ"/>
        <button class="btn" id="addGroupBtn">+ ÂàÜÁªÑ</button>
        <button class="btn" id="clearBtn">üßπ Ê∏ÖÁ©∫</button>
    </div>

    <div id="groups"></div>

    <footer id="footer" style="margin:40px 0;text-align:center;font-size:13px;opacity:.7"></footer>
    <div id="context" class="context hidden"></div>
</div>

<script type="module">
    /* =============================
     * ÂºïÂÖ•Êï∞ÊçÆÂ±Ç
     * ============================= */
    import {
        state,
        loadAppState,
        applyGroupOrder,
        persistState,
        clearAllData
    } from './data.js';

    /* =============================
     * Â∑•ÂÖ∑
     * ============================= */
    const $ = id => document.getElementById(id);

    /* =============================
     * Ê∏≤Êüì
     * ============================= */
    function render(){
        $('title').innerText = state.config.title || 'Nav-site';
        $('subtitle').innerText = state.config.subTitle || '';
        $('footer').innerHTML =
            (state.config.footerText || '').replace('{CURRENT_YEAR}', new Date().getFullYear());

        const box = $('groups');
        box.innerHTML = '';

        state.categoryList.forEach(cat=>{
            const group = document.createElement('div');
            group.className = 'group';
            group.draggable = true;

            const header = document.createElement('div');
            header.className = 'group-header';
            header.innerHTML = `<span>${cat.name}</span><span>(${countItems(cat.id)})</span>`;

            const cards = document.createElement('div');
            cards.className = 'cards';

            // ‚úÖ Âè≥ÈîÆËèúÂçïÔºà‰øÆÂ§çÁâàÔºâ
            cards.oncontextmenu = e => {
                e.preventDefault();
                showMenu(e.clientX, e.clientY, [
                    { text: '‚ûï Â¢ûÂä†Á´ôÁÇπ', fn: () => openSiteModal(null, cat.id) }
                ]);
            };
            group.appendChild(header);
            group.appendChild(cards);
            box.appendChild(group);

            state.data
                .filter(i => i.categoryId === cat.id)
                .sort((a,b)=>a.weight-b.weight)
                .forEach(item=>{
                    const c = document.createElement('div');
                    c.className = 'card';
                    c.draggable = true;

                    c.innerHTML = `
          <div class="ico"><img src="${item.logoUrl || ''}"></div>
          <div>
            <strong>${item.name}</strong>
            <div style="font-size:12px;opacity:.7">${item.desc || ''}</div>
          </div>
        `;

                    c.onclick = () => window.open(item.url, '_blank');
                    cards.appendChild(c);
                });

            group.appendChild(header);
            group.appendChild(cards);
            box.appendChild(group);
        });
    }


    /* ===== Âè≥ÈîÆËèúÂçï ===== */
    const menu=$('context');
    function showMenu(x, y, items) {
        const menu = document.getElementById('context');
        menu.innerHTML = '';
        items.forEach(it => {
            const div = document.createElement('div');
            div.innerText = it.text;
            div.onclick = () => {
                it.fn();
                menu.classList.add('hidden');
            };
            menu.appendChild(div);
        });
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        menu.classList.remove('hidden');
    }

    document.onclick=()=>menu.classList.add('hidden');

    /* ===== ÁºñËæëÂºπÁ™ó ===== */
    function openSiteModal(item,categoryId){
        const mask=$('modalMask');
        mask.innerHTML=`
    <div class="modal">
      <h3>${item?'ÁºñËæëÁ´ôÁÇπ':'Êñ∞Â¢ûÁ´ôÁÇπ'}</h3>
      <label>ÂêçÁß∞</label>
      <input id="m_name" value="${item?.name||''}">
      <label>ÊèèËø∞</label>
      <textarea id="m_desc">${item?.desc||''}</textarea>
      <label>URL</label>
      <input id="m_url" value="${item?.url||''}">
      <div class="modal-actions">
        <button class="btn" onclick="closeModal()">ÂèñÊ∂à</button>
        <button class="btn" onclick="saveSite(${item?.id||'null'},${categoryId})">‰øùÂ≠ò</button>
      </div>
    </div>`;
        mask.classList.remove('hidden');
    }
    function closeModal(){$('modalMask').classList.add('hidden')}

    function saveSite(id,categoryId){
        const name=$('m_name').value;
        const desc=$('m_desc').value;
        const url=$('m_url').value;
        if(!url)return alert('URL ÂøÖÂ°´');
        if(id){
            const i=state.data.find(i=>i.id===id);
            Object.assign(i,{name,desc,url,logoUrl:autoLogo(url)});
        }else{
            state.data.push({
                id:Date.now(),
                categoryId,
                name,
                desc,
                url,
                logoUrl:autoLogo(url)
            });
        }
        save();closeModal();render();
    }
    function deleteSite(id){
        state.data=state.data.filter(i=>i.id!==id);
        save();render();
    }



    function countItems(cid){
        return state.data.filter(d=>d.categoryId===cid).length;
    }

    /* =============================
     * ‰∫ã‰ª∂
     * ============================= */
    $('addGroupBtn').onclick = ()=>{
        const name = prompt('ÂàÜÁªÑÂêçÁß∞');
        if(!name) return;
        state.categoryList.push({
            id: Date.now(),
            name,
            desc: name,
            weight: state.categoryList.length
        });
        persistState();
        render();
    };

    $('clearBtn').onclick = ()=>{
        if(confirm('Á°ÆËÆ§Ê∏ÖÁ©∫ÊâÄÊúâÈÖçÁΩÆÔºü')){
            clearAllData();
            render();
        }
    };

    $('search').oninput = e=>{
        const q = e.target.value.toLowerCase();
        document.querySelectorAll('.card').forEach(c=>{
            c.classList.toggle('hidden', !c.innerText.toLowerCase().includes(q));
        });
    };

    /* =============================
     * ÂêØÂä®
     * ============================= */
    async function bootstrap(){
        await loadAppState();
        applyGroupOrder();
        render();
    }
    bootstrap();
</script>
</body>
</html>