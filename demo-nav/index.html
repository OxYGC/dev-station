<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Nav-site Pro</title>

    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",sans-serif;
            min-height:100vh;
            padding:20px;
            color:#0f172a;
        }
        body::before{
            content:"";
            position:fixed;
            inset:0;
            z-index:-1;
            background:linear-gradient(120deg,#6366f1,#22d3ee,#a78bfa,#6366f1);
            background-size:300% 300%;
            animation:gradient 18s ease infinite;
        }
        @keyframes gradient{
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }

        .container{max-width:1200px;margin:auto}
        .toolbar,.group,.context{
            background:rgba(255,255,255,.75);
            backdrop-filter:blur(14px);
            border-radius:14px;
        }

        .toolbar{
            padding:12px;
            display:flex;
            gap:10px;
            align-items:center;
            margin-bottom:20px;
        }
        .toolbar h1{font-size:22px}
        .search{flex:1;max-width:220px;padding:6px 10px;border-radius:8px;border:1px solid #ccc}
        .btn{padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}

        .group{margin-bottom:18px}
        .group-header{
            padding:12px 16px;
            font-weight:600;
            cursor:grab;
        }
        .group-header.dragging{opacity:.4}

        .cards{
            padding:12px;
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
            gap:10px;
            min-height:60px;
        }
        .cards.drag-over{outline:2px dashed #6366f1}

        .card{
            display:flex;
            gap:10px;
            padding:10px;
            border-radius:10px;
            background:#fff;
            cursor:grab;
        }
        .card.dragging{opacity:.4}
        .placeholder{
            border:2px dashed #6366f1;
            border-radius:10px;
            height:52px;
        }

        .ico{width:36px;height:36px;border-radius:8px;background:#eef2ff;display:flex;align-items:center;justify-content:center}
        .ico img{width:100%;height:100%;object-fit:contain}
        .info h3{font-size:14px}
        .info p{font-size:12px;color:#64748b}

        .hidden{display:none}

        .context{
            position:fixed;
            z-index:999;
            padding:6px;
            box-shadow:0 8px 20px rgba(0,0,0,.15);
        }
        .context div{
            padding:6px 14px;
            cursor:pointer;
            white-space:nowrap;
        }
        .context div:hover{background:#e0e7ff}
    </style>
</head>

<body>
<div class="container">
    <div class="toolbar">
        <h1 id="title"></h1>
        <input id="search" class="search" placeholder="æœç´¢ï¼ˆ/ï¼‰"/>
        <button class="btn" id="exportBtn">å¯¼å‡º JSON</button>
        <button class="btn" id="importBtn">å¯¼å…¥ JSON</button>
    </div>
    <div id="groups"></div>
</div>

<input type="file" id="fileInput" hidden />
<div id="context" class="context hidden"></div>

<script>
    const STORAGE_KEY='nav_site_data_v2';
    const GROUP_ORDER_KEY='nav_group_order';
    const DEFAULT_CONF_URL='https://raw.githubusercontent.com/OxYGC/dev-station/refs/heads/main/demo-nav/data/default-conf.json';

    let state={config:{},categoryList:[],data:[]};
    let dragItem=null,dragGroup=null;
    const placeholder=document.createElement('div');
    placeholder.className='placeholder';

    const $=id=>document.getElementById(id);
    const save=()=>{
        localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
        localStorage.setItem(GROUP_ORDER_KEY,JSON.stringify(state.categoryList.map(c=>c.id)));
    };

    async function fetchSiteMeta(url){
        try{
            const res=await fetch(url,{mode:'cors'});
            const html=await res.text();
            const doc=new DOMParser().parseFromString(html,'text/html');
            return{
                title:doc.querySelector('meta[property="og:title"]')?.content
                    || doc.title
                    || new URL(url).hostname,
                icon:doc.querySelector('link[rel~="icon"]')?.href
                    || `https://www.google.com/s2/favicons?sz=64&domain=${new URL(url).hostname}`
            };
        }catch{
            return{
                title:new URL(url).hostname,
                icon:`https://www.google.com/s2/favicons?sz=64&domain=${new URL(url).hostname}`
            };
        }
    }

    async function init(){
        const local=localStorage.getItem(STORAGE_KEY);
        if(local){
            state=JSON.parse(local);
            render();
            return;
        }
        const conf=await fetch(DEFAULT_CONF_URL).then(r=>r.json());
        state.config=conf.config||{};
        const remote=await fetch(conf.api.homeUrl).then(r=>r.json());
        state.categoryList=remote.categoryList||[];
        state.data=remote.data||[];
        save();render();
    }

    function render(){
        $('title').innerText=state.config.title||'Nav-site';
        const box=$('groups');box.innerHTML='';

        state.categoryList.forEach((cat,idx)=>{
            const g=document.createElement('div');
            g.className='group';
            g.draggable=true;

            g.ondragstart=()=>dragGroup=cat;
            g.ondragend=()=>dragGroup=null;
            g.ondragover=e=>{
                e.preventDefault();
                const target=[...box.children].find(el=>{
                    const r=el.getBoundingClientRect();
                    return e.clientY<r.top+r.height/2;
                });
                box.insertBefore(g,target||null);
            };
            g.ondrop=()=>{
                state.categoryList=[...box.children].map(el=>{
                    const name=el.querySelector('.group-header').innerText;
                    return state.categoryList.find(c=>c.name===name);
                });
                save();render();
            };

            g.innerHTML=`<div class="group-header">${cat.name}</div><div class="cards" data-id="${cat.id}"></div>`;
            const cards=g.querySelector('.cards');

            cards.ondragover=e=>{
                e.preventDefault();
                const after=[...cards.children].find(c=>{
                    const r=c.getBoundingClientRect();
                    return e.clientY<r.top+r.height/2;
                });
                cards.insertBefore(placeholder,after||null);
            };
            cards.ondrop=()=>{
                if(dragItem){
                    dragItem.categoryId=cat.id;
                    save();render();
                }
            };

            state.data.filter(i=>i.categoryId===cat.id).forEach(i=>{
                const c=document.createElement('div');
                c.className='card';c.draggable=true;
                c.innerHTML=`<div class="ico"><img src="${i.logoUrl}"></div>
        <div class="info"><h3>${i.name}</h3><p>${i.desc||i.url}</p></div>`;
                c.ondragstart=()=>dragItem=i;
                c.oncontextmenu=e=>siteMenu(e,i);
                cards.appendChild(c);
            });

            g.querySelector('.group-header').oncontextmenu=e=>groupMenu(e,cat);
            box.appendChild(g);
        });
    }

    /* ===== å³é”®èœå• ===== */
    const menu=$('context');
    function showMenu(x,y,items){
        menu.innerHTML=items.map(i=>`<div onclick="${i.fn}">${i.text}</div>`).join('');
        const w=180,h=items.length*32;
        if(x+w>innerWidth)x-=w;
        if(y+h>innerHeight)y-=h;
        menu.style.left=x+'px';menu.style.top=y+'px';
        menu.classList.remove('hidden');
    }
    document.onclick=()=>menu.classList.add('hidden');
    document.onkeydown=e=>e.key==='Escape'&&menu.classList.add('hidden');

    function groupMenu(e,cat){
        e.preventDefault();
        showMenu(e.clientX,e.clientY,[
            {text:'âœï¸ é‡å‘½å',fn:`renameGroup(${cat.id})`},
            {text:'â¬†ï¸ ä¸Šç§»',fn:`moveGroup(${cat.id},-1)`},
            {text:'â¬‡ï¸ ä¸‹ç§»',fn:`moveGroup(${cat.id},1)`},
            {text:'ðŸ—‘ åˆ é™¤',fn:`deleteGroup(${cat.id})`}
        ]);
    }

    function siteMenu(e,item){
        e.preventDefault();
        showMenu(e.clientX,e.clientY,[
            {text:'ðŸ”— æ‰“å¼€',fn:`window.open('${item.url}')`},
            {text:'ðŸ”„ é‡æ–°æŠ“å– Meta',fn:`refreshMeta(${item.id})`},
            {text:'âœï¸ ç¼–è¾‘',fn:`editSite(${item.id})`},
            {text:'ðŸ—‘ åˆ é™¤',fn:`deleteSite(${item.id})`}
        ]);
    }

    async function refreshMeta(id){
        const i=state.data.find(i=>i.id===id);
        const m=await fetchSiteMeta(i.url);
        i.name=m.title;i.logoUrl=m.icon;
        save();render();
    }

    function renameGroup(id){
        const c=state.categoryList.find(c=>c.id===id);
        const n=prompt('æ–°åç§°',c.name);if(!n)return;
        c.name=n;save();render();
    }
    function moveGroup(id,step){
        const i=state.categoryList.findIndex(c=>c.id===id);
        const j=i+step;if(j<0||j>=state.categoryList.length)return;
        [state.categoryList[i],state.categoryList[j]]=[state.categoryList[j],state.categoryList[i]];
        save();render();
    }
    function deleteGroup(id){
        if(!confirm('åˆ é™¤åˆ†ç»„åŠç«™ç‚¹ï¼Ÿ'))return;
        state.categoryList=state.categoryList.filter(c=>c.id!==id);
        state.data=state.data.filter(i=>i.categoryId!==id);
        save();render();
    }
    function editSite(id){
        const i=state.data.find(i=>i.id===id);
        const u=prompt('URL',i.url);if(!u)return;
        fetchSiteMeta(u).then(m=>{
            i.url=u;i.name=m.title;i.logoUrl=m.icon;
            save();render();
        });
    }
    function deleteSite(id){
        state.data=state.data.filter(i=>i.id!==id);
        save();render();
    }

    /* ===== å¯¼å…¥å¯¼å‡º ===== */
    $('exportBtn').onclick=()=>{
        const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download='nav-site.json';
        a.click();
    };
    $('importBtn').onclick=()=>$('fileInput').click();
    $('fileInput').onchange=e=>{
        const f=e.target.files[0];if(!f)return;
        const r=new FileReader();
        r.onload=()=>{
            state=JSON.parse(r.result);
            save();render();
        };
        r.readAsText(f);
    };

    init();
</script>
</body>
</html>