<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nav-site | ‰∏™‰∫∫ÂØºËà™ÁÆ°ÁêÜ</title>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-color: #764ba2;
            --text-main: #2d3436;
            --text-sub: #636e72;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            padding: 40px 20px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header & Search */
        header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .search-bar {
            margin: 20px auto;
            max-width: 500px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            outline: none;
            font-size: 16px;
            transition: all 0.3s;
        }

        .toolbar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background: var(--glass-bg);
            backdrop-filter: blur(5px);
            transition: 0.3s;
        }

        .btn:hover { background: white; transform: translateY(-2px); }
        .btn-danger { color: #d63031; }

        /* Category System */
        .category-section {
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            cursor: move;
        }

        .category-title { font-size: 1.2rem; font-weight: bold; color: white; }
        .category-count { font-size: 0.8rem; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; }

        /* Card Grid */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .site-card {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit;
            transition: 0.3s;
            border: 1px solid transparent;
            cursor: pointer;
            position: relative;
        }

        .site-card:hover {
            transform: translateY(-5px);
            background: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .site-card.dragging { opacity: 0.5; }

        .site-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f1f2f6;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .site-logo img { width: 100%; height: 100%; object-fit: cover; }

        .site-info { flex: 1; overflow: hidden; }
        .site-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .site-desc { font-size: 0.75rem; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Context Menu */
        #context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            padding: 5px 0;
            min-width: 120px;
        }

        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }

        .menu-item:hover { background: #f1f2f6; color: var(--accent-color); }
        .menu-item.danger { color: #d63031; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
        }

        .modal h3 { margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        [draggable="true"] { cursor: grab; }
        .drag-over { border: 2px dashed var(--accent-color) !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="site-title">Nav-site</h1>
        <p id="site-subtitle">ÊàëÁöÑÊûÅÁÆÄÂØºËà™</p>
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="ÊêúÁ¥¢Á´ôÁÇπ...">
        </div>
        <div class="toolbar">
            <button class="btn" onclick="ui.showModal('category')">‚ûï Êñ∞Â¢ûÂàÜÁªÑ</button>
            <button class="btn btn-danger" onclick="app.resetData()">üßπ Ê∏ÖÁ©∫ÈÖçÁΩÆ</button>
        </div>
    </header>

    <main id="nav-content"></main>
</div>

<div id="context-menu"></div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal">
        <h3 id="modal-title">ÁºñËæë‰ø°ÊÅØ</h3>
        <div id="modal-form"></div>
        <div class="modal-btns">
            <button class="btn" onclick="ui.closeModal()">ÂèñÊ∂à</button>
            <button class="btn" style="background: var(--accent-color); color: white;" id="modal-save">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<script>
    /**
     * Ê†∏ÂøÉÈÄªËæëÊ®°Âùó
     */
    const STORAGE_KEY = 'nav_site_data_v2';
    const DEFAULT_CONF_URL = 'https://raw.githubusercontent.com/OxYGC/dev-station/refs/heads/main/demo-nav/data/default-conf.json';

    const app = {
        state: {
            config: { title: 'Nav-site', subTitle: 'Êú¨Âú∞‰ºòÂÖàÂØºËà™Á´ô' },
            categoryList: [],
            data: []
        },

        async init() {
            const localData = localStorage.getItem(STORAGE_KEY);
            if (localData) {
                try {
                    this.state = JSON.parse(localData);
                    this.render();
                } catch (e) {
                    console.error("Local storage error", e);
                    this.loadRemoteData();
                }
            } else {
                this.loadRemoteData();
            }
            this.bindGlobalEvents();
        },

        async loadRemoteData() {
            try {
                const resp = await fetch(DEFAULT_CONF_URL);
                const conf = await resp.json();
                if (conf.api && conf.api.homeUrl) {
                    const dataResp = await fetch(conf.api.homeUrl);
                    const realData = await dataResp.json();
                    this.state.categoryList = realData.categoryList || [];
                    this.state.data = realData.data || [];
                    this.state.config = conf.config || this.state.config;
                    this.save();
                    this.render();
                }
            } catch (e) {
                console.warn("ËøúÁ®ãÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Á©∫ÁôΩÈÖçÁΩÆ", e);
                this.render();
            }
        },

        save() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(this.state));
        },

        render() {
            ui.renderAll(this.state);
        },

        resetData() {
            if(confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
    };

    /**
     * UI Ê∏≤ÊüìÂºïÊìé
     */
    const ui = {
        renderAll(state) {
            document.getElementById('site-title').innerText = state.config.title;
            document.getElementById('site-subtitle').innerText = state.config.subTitle || '';

            const container = document.getElementById('nav-content');
            container.innerHTML = '';

            // ÊåâÊùÉÈáçÊéíÂ∫èÂàÜÁªÑ
            const sortedCats = [...state.categoryList].sort((a,b) => (a.weight || 0) - (b.weight || 0));

            sortedCats.forEach(cat => {
                const section = document.createElement('section');
                section.className = 'category-section';
                section.dataset.id = cat.id;
                section.draggable = true;

                const catSites = state.data.filter(s => s.categoryId === cat.id);

                section.innerHTML = `
                <div class="category-header">
                    <div class="category-title">
                        ${cat.name} <span class="category-count">${catSites.length}</span>
                    </div>
                </div>
                <div class="card-grid" data-cat-id="${cat.id}"></div>
            `;

                const grid = section.querySelector('.card-grid');
                catSites.sort((a,b) => (a.weight || 0) - (b.weight || 0)).forEach(site => {
                    grid.appendChild(this.createCard(site));
                });

                // ÁªëÂÆöÂè≥ÈîÆÂíåÊãñÊãΩ
                section.oncontextmenu = (e) => this.showContextMenu(e, 'category', cat.id);
                this.bindDragEvents(section, 'category');

                container.appendChild(section);
            });
        },

        createCard(site) {
            const card = document.createElement('a');
            card.className = 'site-card';
            card.href = site.url;
            card.target = '_blank';
            card.draggable = true;
            card.dataset.id = site.id;

            const domain = new URL(site.url).hostname;
            const icon = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;

            card.innerHTML = `
            <div class="site-logo"><img src="${icon}" alt="logo"></div>
            <div class="site-info">
                <div class="site-name">${site.name}</div>
                <div class="site-desc">${site.desc || site.url}</div>
            </div>
        `;

            card.oncontextmenu = (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.showContextMenu(e, 'site', site.id);
            };

            this.bindDragEvents(card, 'site');
            return card;
        },

        // ‰∫§‰∫íÈÄªËæë
        showContextMenu(e, type, id) {
            e.preventDefault();
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';

            let items = [];
            if (type === 'category') {
                items = [
                    { label: '‚ûï Êñ∞Â¢ûÁ´ôÁÇπ', action: () => ui.showModal('site', { categoryId: id }) },
                    { label: 'üóë Âà†Èô§ÂàÜÁªÑ', danger: true, action: () => actions.deleteCategory(id) }
                ];
            } else {
                items = [
                    { label: '‚úèÔ∏è ÁºñËæëÁ´ôÁÇπ', action: () => ui.showModal('site', { id: id }) },
                    { label: 'üóë Âà†Èô§Á´ôÁÇπ', danger: true, action: () => actions.deleteSite(id) }
                ];
            }

            menu.innerHTML = items.map(item => `
            <div class="menu-item ${item.danger ? 'danger' : ''}" onclick="this.dataset.clicked=true">${item.label}</div>
        `).join('');

            menu.querySelectorAll('.menu-item').forEach((el, idx) => {
                el.onclick = (ev) => {
                    ev.stopPropagation();
                    items[idx].action();
                    menu.style.display = 'none';
                };
            });
        },

        showModal(type, params = {}) {
            const overlay = document.getElementById('modal-overlay');
            const form = document.getElementById('modal-form');
            const saveBtn = document.getElementById('modal-save');
            overlay.style.display = 'flex';

            if (type === 'category') {
                document.getElementById('modal-title').innerText = 'Êñ∞Â¢ûÂàÜÁªÑ';
                form.innerHTML = `<div class="form-group"><label>ÂêçÁß∞</label><input id="f-name" type="text"></div>`;
                saveBtn.onclick = () => {
                    actions.addCategory(document.getElementById('f-name').value);
                    this.closeModal();
                };
            } else {
                const isEdit = !!params.id;
                const site = isEdit ? app.state.data.find(s => s.id === params.id) : null;
                document.getElementById('modal-title').innerText = isEdit ? 'ÁºñËæëÁ´ôÁÇπ' : 'Êñ∞Â¢ûÁ´ôÁÇπ';
                form.innerHTML = `
                <div class="form-group"><label>ÂêçÁß∞</label><input id="f-name" value="${site ? site.name : ''}"></div>
                <div class="form-group"><label>ÊèèËø∞</label><input id="f-desc" value="${site ? site.desc : ''}"></div>
                <div class="form-group"><label>URL</label><input id="f-url" value="${site ? site.url : 'https://'}"></div>
            `;
                saveBtn.onclick = () => {
                    const data = {
                        name: document.getElementById('f-name').value,
                        desc: document.getElementById('f-desc').value,
                        url: document.getElementById('f-url').value,
                        categoryId: params.categoryId || site.categoryId
                    };
                    isEdit ? actions.updateSite(params.id, data) : actions.addSite(data);
                    this.closeModal();
                };
            }
        },

        closeModal() { document.getElementById('modal-overlay').style.display = 'none'; },

        /**
         * ÊãñÊãΩÊ†∏ÂøÉÂÆûÁé∞
         */
        draggingType: null,
        draggingId: null,

        bindDragEvents(el, type) {
            el.addEventListener('dragstart', (e) => {
                e.stopPropagation();
                this.draggingType = type;
                this.draggingId = el.dataset.id;
                el.classList.add('dragging');
            });

            el.addEventListener('dragend', () => {
                el.classList.remove('dragging');
                document.querySelectorAll('.drag-over').forEach(n => n.classList.remove('drag-over'));
            });

            el.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                el.classList.add('drag-over');
            });

            el.addEventListener('dragleave', () => el.classList.remove('drag-over'));

            el.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const targetId = el.dataset.id;

                if (this.draggingType === 'site' && type === 'site') {
                    actions.reorderSite(this.draggingId, targetId);
                } else if (this.draggingType === 'category' && type === 'category') {
                    actions.reorderCategory(this.draggingId, targetId);
                } else if (this.draggingType === 'site' && type === 'category') {
                    actions.moveSiteToCategory(this.draggingId, targetId);
                }
            });
        }
    };

    /**
     * Êï∞ÊçÆÊìç‰ΩúÊ®°Âùó
     */
    const actions = {
        addCategory(name) {
            if (!name) return;
            app.state.categoryList.push({ id: Date.now(), name, weight: app.state.categoryList.length });
            this.finish();
        },
        deleteCategory(id) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§ÂàÜÁªÑÂèäÂÖ∂‰∏ãÊâÄÊúâÁ´ôÁÇπÂêóÔºü')) return;
            app.state.categoryList = app.state.categoryList.filter(c => c.id != id);
            app.state.data = app.state.data.filter(s => s.categoryId != id);
            this.finish();
        },
        addSite(data) {
            app.state.data.push({ ...data, id: Date.now(), weight: 999 });
            this.finish();
        },
        updateSite(id, data) {
            const idx = app.state.data.findIndex(s => s.id == id);
            app.state.data[idx] = { ...app.state.data[idx], ...data };
            this.finish();
        },
        deleteSite(id) {
            app.state.data = app.state.data.filter(s => s.id != id);
            this.finish();
        },
        moveSiteToCategory(siteId, catId) {
            const site = app.state.data.find(s => s.id == siteId);
            if (site) {
                site.categoryId = parseInt(catId);
                this.finish();
            }
        },
        reorderCategory(srcId, targetId) {
            const list = app.state.categoryList;
            const srcIdx = list.findIndex(c => c.id == srcId);
            const targetIdx = list.findIndex(c => c.id == targetId);
            const [moved] = list.splice(srcIdx, 1);
            list.splice(targetIdx, 0, moved);
            list.forEach((c, i) => c.weight = i);
            this.finish();
        },
        reorderSite(srcId, targetId) {
            const list = app.state.data;
            const srcIdx = list.findIndex(s => s.id == srcId);
            const targetIdx = list.findIndex(s => s.id == targetId);
            const targetCatId = list[targetIdx].categoryId;
            const [moved] = list.splice(srcIdx, 1);
            moved.categoryId = targetCatId; // ÂÖÅËÆ∏Âú®ÊãñÊãΩÊéíÂ∫èÊó∂ÊîπÂèòÂàÜÁªÑ
            list.splice(targetIdx, 0, moved);
            list.forEach((s, i) => s.weight = i);
            this.finish();
        },
        finish() {
            app.save();
            app.render();
        }
    };

    // ÂÖ®Â±Ä‰∫ã‰ª∂ÔºöÁÇπÂáªÂÖ≥Èó≠ËèúÂçï & ÊêúÁ¥¢
    app.bindGlobalEvents = () => {
        window.onclick = () => {
            document.getElementById('context-menu').style.display = 'none';
        };

        document.getElementById('search-input').oninput = (e) => {
            const val = e.target.value.toLowerCase();
            document.querySelectorAll('.site-card').forEach(card => {
                const name = card.querySelector('.site-name').innerText.toLowerCase();
                const desc = card.querySelector('.site-desc').innerText.toLowerCase();
                card.style.display = (name.includes(val) || desc.includes(val)) ? 'flex' : 'none';
            });
        };
    };

    // ÂêØÂä®
    app.init();
</script>

</body>
</html>