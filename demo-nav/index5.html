<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nav-site | Pro ÂØºËà™ÁÆ°ÁêÜ</title>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --accent-color: #764ba2;
            --text-main: #2d3436;
            --text-sub: #636e72;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'PingFang SC', system-ui, sans-serif;
            min-height: 100vh;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            padding: 40px 20px;
        }

        @keyframes gradientBG { 0% {background-position:0% 50%} 50% {background-position:100% 50%} 100% {background-position:0% 50%} }

        .container { max-width: 1200px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 30px; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        .search-bar { margin: 15px auto; max-width: 500px; }
        .search-bar input {
            width: 100%; padding: 10px 20px; border-radius: 50px; border: 1px solid var(--glass-border);
            background: var(--glass-bg); backdrop-filter: blur(10px); outline: none;
        }

        .toolbar { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; flex-wrap: wrap; }
        .btn {
            padding: 6px 14px; border-radius: 8px; border: none; cursor: pointer;
            background: var(--glass-bg); backdrop-filter: blur(5px); transition: 0.2s; font-size: 13px;
        }
        .btn:hover { background: white; transform: translateY(-1px); }
        .btn-primary { background: var(--accent-color); color: white; }

        /* Category Section */
        .category-section {
            margin-bottom: 25px; background: rgba(255, 255, 255, 0.2);
            border-radius: 16px; padding: 18px; backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }

        .category-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; cursor: move;
        }

        .category-info { display: flex; align-items: center; gap: 10px; color: white; font-weight: bold; }
        .category-count { font-size: 0.75rem; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; }

        .expand-btn {
            background: none; border: 1px solid rgba(255,255,255,0.4); color: white;
            padding: 2px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; display: none;
        }

        /* Card Grid - Compact Mode */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            max-height: 140px; /* ÈªòËÆ§ÊòæÁ§∫Á∫¶‰∏§Ë°åÁöÑÈ´òÂ∫¶ */
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .category-section.expanded .card-grid { max-height: 2000px; }

        .site-card {
            background: var(--glass-bg); border-radius: 10px; padding: 8px 12px;
            display: flex; align-items: center; gap: 10px; text-decoration: none;
            color: inherit; border: 1px solid transparent; height: 60px;
        }
        .site-card:hover { transform: scale(1.02); background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        .site-logo { width: 32px; height: 32px; border-radius: 6px; flex-shrink: 0; }
        .site-info { flex: 1; min-width: 0; }
        .site-name { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .site-desc { font-size: 0.7rem; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Context Menu & Modal */
        #context-menu { position: fixed; background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: none; z-index: 1000; padding: 5px 0; min-width: 130px; }
        .menu-item { padding: 8px 16px; cursor: pointer; font-size: 13px; }
        .menu-item:hover { background: #f5f5f5; color: var(--accent-color); }
        .modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 380px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: 13px; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }

        .drag-over { border: 2px dashed #fff !important; }
        .dragging { opacity: 0.4; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="site-title">Nav-site</h1>
        <div class="search-bar"><input type="text" id="search-input" placeholder="ÂÖ®Â±ÄÊêúÁ¥¢Á´ôÁÇπ..."></div>
        <div class="toolbar">
            <button class="btn btn-primary" onclick="ui.showModal('category')">‚ûï Êñ∞Â¢ûÂàÜÁªÑ</button>
            <button class="btn" onclick="io.exportData()">üì§ ÂØºÂá∫ÈÖçÁΩÆ</button>
            <button class="btn" onclick="document.getElementById('import-file').click()">üì• ÂØºÂÖ•ÈÖçÁΩÆ</button>
            <input type="file" id="import-file" hidden accept=".json" onchange="io.importData(event)">
            <button class="btn" style="color:#d63031" onclick="app.resetData()">üßπ ÈáçÁΩÆ</button>
        </div>
    </header>
    <main id="nav-content"></main>
</div>

<div id="context-menu"></div>
<div class="modal-overlay" id="modal-overlay">
    <div class="modal">
        <h3 id="modal-title" style="margin-bottom:15px">ÁºñËæë</h3>
        <div id="modal-form"></div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:15px">
            <button class="btn" onclick="ui.closeModal()">ÂèñÊ∂à</button>
            <button class="btn btn-primary" id="modal-save">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'nav_site_data_v2';
    const app = {
        state: { config: { title: 'Nav-site' }, categoryList: [], data: [] },
        async init() {
            const local = localStorage.getItem(STORAGE_KEY);
            if (local) {
                this.state = JSON.parse(local);
            } else {
                // ÈªòËÆ§ÂºïÂØºÊï∞ÊçÆ
                this.state.categoryList = [{id: 1, name: 'Â∏∏Áî®Êé®Ëçê', weight: 0}];
                this.state.data = [{id: 101, categoryId: 1, name: 'Google', url: 'https://google.com', desc: 'ÂÖ®ÁêÉÊêúÁ¥¢'}];
            }
            this.render();
            this.bindGlobal();
        },
        save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(this.state)); },
        render() { ui.renderAll(this.state); },
        resetData() { if(confirm('Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÔºü')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
    };

    const io = {
        exportData() {
            const blob = new Blob([JSON.stringify(app.state, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nav-site-backup-${new Date().toLocaleDateString()}.json`;
            a.click();
        },
        importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (f) => {
                try {
                    const imported = JSON.parse(f.target.result);
                    if (imported.categoryList && imported.data) {
                        app.state = imported;
                        app.save();
                        location.reload();
                    } else { alert('Êñá‰ª∂Ê†ºÂºèÈùûÊ≥ï'); }
                } catch (err) { alert('Ëß£ÊûêÂ§±Ë¥•'); }
            };
            reader.readAsText(file);
        }
    };

    const ui = {
        renderAll(state) {
            document.getElementById('site-title').innerText = state.config.title;
            const container = document.getElementById('nav-content');
            container.innerHTML = '';

            [...state.categoryList].sort((a,b) => a.weight - b.weight).forEach(cat => {
                const section = document.createElement('section');
                section.className = 'category-section';
                section.dataset.id = cat.id;
                section.draggable = true;

                const sites = state.data.filter(s => s.categoryId === cat.id).sort((a,b) => a.weight - b.weight);

                section.innerHTML = `
                <div class="category-header">
                    <div class="category-info">
                        <span>${cat.name}</span>
                        <span class="category-count">${sites.length}</span>
                    </div>
                    <button class="expand-btn" onclick="ui.toggleExpand(${cat.id})">Â±ïÂºÄÂÖ®ÈÉ®</button>
                </div>
                <div class="card-grid" id="grid-${cat.id}"></div>
            `;

                const grid = section.querySelector('.card-grid');
                sites.forEach(s => grid.appendChild(this.createCard(s)));

                container.appendChild(section);
                this.checkOverflow(cat.id);
                this.bindDrag(section, 'category');
                section.oncontextmenu = (e) => this.showMenu(e, 'category', cat.id);
            });
        },

        createCard(site) {
            const card = document.createElement('a');
            card.className = 'site-card';
            card.href = site.url; card.target = '_blank'; card.draggable = true; card.dataset.id = site.id;
            const icon = `https://www.google.com/s2/favicons?domain=${new URL(site.url).hostname}&sz=64`;
            card.innerHTML = `
            <img class="site-logo" src="${icon}" onerror="this.src='https://via.placeholder.com/32'">
            <div class="site-info">
                <div class="site-name">${site.name}</div>
                <div class="site-desc">${site.desc || site.url}</div>
            </div>
        `;
            card.oncontextmenu = (e) => { e.preventDefault(); e.stopPropagation(); this.showMenu(e, 'site', site.id); };
            this.bindDrag(card, 'site');
            return card;
        },

        checkOverflow(catId) {
            setTimeout(() => {
                const grid = document.getElementById(`grid-${catId}`);
                if (grid.scrollHeight > grid.clientHeight + 5) {
                    grid.parentElement.querySelector('.expand-btn').style.display = 'block';
                }
            }, 100);
        },

        toggleExpand(catId) {
            const section = document.querySelector(`.category-section[data-id="${catId}"]`);
            const btn = section.querySelector('.expand-btn');
            const isExpanded = section.classList.toggle('expanded');
            btn.innerText = isExpanded ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄÂÖ®ÈÉ®';
        },

        showMenu(e, type, id) {
            e.preventDefault();
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block'; menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px';

            let items = type === 'category' ? [
                { label: '‚ûï Êñ∞Â¢ûÁ´ôÁÇπ', act: () => this.showModal('site', { categoryId: id }) },
                { label: 'üóë Âà†Èô§ÂàÜÁªÑ', act: () => { if(confirm('Âà†ÂàÜÁªÑÔºü')) actions.delCat(id) } }
            ] : [
                { label: '‚úèÔ∏è ÁºñËæëÁ´ôÁÇπ', act: () => this.showModal('site', { id }) },
                { label: 'üóë Âà†Èô§Á´ôÁÇπ', act: () => actions.delSite(id) }
            ];

            menu.innerHTML = items.map(i => `<div class="menu-item">${i.label}</div>`).join('');
            menu.querySelectorAll('.menu-item').forEach((el, idx) => el.onclick = items[idx].act);
        },

        showModal(type, p = {}) {
            const overlay = document.getElementById('modal-overlay');
            const form = document.getElementById('modal-form');
            overlay.style.display = 'flex';
            if (type === 'category') {
                form.innerHTML = `<div class="form-group"><label>ÂàÜÁªÑÂêç</label><input id="f-name"></div>`;
                document.getElementById('modal-save').onclick = () => { actions.addCat(document.getElementById('f-name').value); this.closeModal(); };
            } else {
                const s = p.id ? app.state.data.find(x => x.id == p.id) : null;
                form.innerHTML = `
                <div class="form-group"><label>ÂêçÁß∞</label><input id="f-name" value="${s?s.name:''}"></div>
                <div class="form-group"><label>URL</label><input id="f-url" value="${s?s.url:'https://'}"></div>
                <div class="form-group"><label>ÊèèËø∞</label><input id="f-desc" value="${s?s.desc:''}"></div>
            `;
                document.getElementById('modal-save').onclick = () => {
                    const d = { name: document.getElementById('f-name').value, url: document.getElementById('f-url').value, desc: document.getElementById('f-desc').value, categoryId: p.categoryId || s.categoryId };
                    p.id ? actions.updSite(p.id, d) : actions.addSite(d);
                    this.closeModal();
                };
            }
        },
        closeModal() { document.getElementById('modal-overlay').style.display = 'none'; },

        bindDrag(el, type) {
            el.ondragstart = (e) => { e.stopPropagation(); this.dragType = type; this.dragId = el.dataset.id; el.classList.add('dragging'); };
            el.ondragend = () => { el.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(x => x.classList.remove('drag-over')); };
            el.ondragover = (e) => { e.preventDefault(); e.stopPropagation(); el.classList.add('drag-over'); };
            el.ondragleave = () => el.classList.remove('drag-over');
            el.ondrop = (e) => {
                e.preventDefault(); e.stopPropagation();
                if (this.dragType === 'site' && type === 'category') actions.moveSite(this.dragId, el.dataset.id);
                if (this.dragType === type) actions.reorder(this.dragType, this.dragId, el.dataset.id);
            };
        }
    };

    const actions = {
        addCat(name) { app.state.categoryList.push({id: Date.now(), name, weight: 99}); this.fin(); },
        delCat(id) { app.state.categoryList = app.state.categoryList.filter(c => c.id != id); this.fin(); },
        addSite(d) { app.state.data.push({...d, id: Date.now(), weight: 99}); this.fin(); },
        updSite(id, d) { const i = app.state.data.findIndex(x => x.id == id); app.state.data[i] = {...app.state.data[i], ...d}; this.fin(); },
        delSite(id) { app.state.data = app.state.data.filter(x => x.id != id); this.fin(); },
        moveSite(sid, cid) { const s = app.state.data.find(x => x.id == sid); if(s) { s.categoryId = parseInt(cid); this.fin(); } },
        reorder(type, sid, tid) {
            const list = type === 'category' ? app.state.categoryList : app.state.data;
            const sIdx = list.findIndex(x => x.id == sid), tIdx = list.findIndex(x => x.id == tid);
            const [m] = list.splice(sIdx, 1); list.splice(tIdx, 0, m);
            list.forEach((x, i) => x.weight = i); this.fin();
        },
        fin() { app.save(); app.render(); }
    };

    app.bindGlobal = () => {
        window.onclick = () => document.getElementById('context-menu').style.display = 'none';
        document.getElementById('search-input').oninput = (e) => {
            const v = e.target.value.toLowerCase();
            document.querySelectorAll('.site-card').forEach(c => {
                const text = c.innerText.toLowerCase();
                c.style.display = text.includes(v) ? 'flex' : 'none';
            });
        };
    };

    app.init();
</script>
</body>
</html>