<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Nav-site</title>

    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",sans-serif;
            background:#f9fafb;color:#1e293b;padding:20px
        }
        .container{max-width:1100px;margin:auto}
        .hidden{display:none}

        /* Toolbar */
        .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:20px}
        .toolbar h1{font-size:22px}
        .search{
            flex:1;
            max-width:260px;
            padding:8px 12px;
            border:1px solid #cbd5e1;
            border-radius:8px
        }

        /* Buttons */
        .btn{padding:6px 12px;border-radius:6px;border:none;cursor:pointer}
        .btn-primary{background:#4f46e5;color:#fff}
        .btn-outline{background:#fff;border:1px solid #cbd5e1}

        /* Group */
        .group{background:#fff;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
        .group-header{
            display:flex;align-items:center;justify-content:space-between;
            padding:12px 16px;background:#f8fafc;
            cursor:grab;user-select:none
        }
        .group-header.dragging{opacity:.5}
        .group-title{font-weight:600}
        .cards{
            padding:14px;
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
            gap:10px;min-height:80px
        }
        .cards.drag-over{
            background:#eef2ff;border-radius:10px
        }

        /* Card */
        .card{
            display:flex;align-items:center;gap:10px;
            padding:8px 10px;border-radius:10px;
            background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.06);
            cursor:grab
        }
        .card.dragging{opacity:.5}
        .ico{width:36px;height:36px;border-radius:6px;background:#f1f5f9;display:flex;align-items:center;justify-content:center}
        .ico img{width:100%;height:100%;object-fit:contain}
        .info{flex:1;min-width:0}
        .info h3{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .info p{font-size:12px;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    </style>
</head>

<body>
<div class="container">

    <div class="toolbar">
        <h1 id="title">导航站点</h1>
        <input id="search" class="search" placeholder="搜索站点 / URL（/ 或 Ctrl+K）"/>
        <button class="btn btn-outline" id="addGroup">+ 新建类型分组</button>
    </div>

    <div id="groups"></div>

    <footer id="footer" style="margin-top:40px;text-align:center;color:#64748b;font-size:13px"></footer>

</div>

<script>
    /* ================= 配置 ================= */
    const STORAGE_KEY='nav_site_data_v2';
    const GROUP_ORDER_KEY='nav_group_order';
    const DEFAULT_CONF='https://raw.githubusercontent.com/OxYGC/dev-station/refs/heads/main/demo-nav/data/default-conf.json';

    let state={config:{},categoryList:[],data:[]};

    /* ================= 工具 ================= */
    const $=id=>document.getElementById(id);
    const save=()=>{
        localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
        localStorage.setItem(GROUP_ORDER_KEY,JSON.stringify(state.categoryList.map(c=>c.id)));
    };
    const autoLogo=url=>{
        try{return `https://www.google.com/s2/favicons?sz=64&domain=${new URL(url).hostname}`}
        catch{return ''}
    };
    const getGroupOrder=()=>{
        try{return JSON.parse(localStorage.getItem(GROUP_ORDER_KEY))||[]}
        catch{return []}
    };

    /* ================= 初始化 ================= */
    async function init(){
        const local=localStorage.getItem(STORAGE_KEY);
        if(local){
            state=JSON.parse(local);
        }else{
            const conf=await fetch(DEFAULT_CONF).then(r=>r.json());
            state.config=conf.config;
            const remote=await fetch(conf.api.homeUrl).then(r=>r.json());
            state.categoryList=remote.categoryList||[];
            state.data=remote.data||[];
            save();
        }

        const order=getGroupOrder();
        if(order.length){
            state.categoryList.sort((a,b)=>order.indexOf(a.id)-order.indexOf(b.id));
        }
        render();
    }

    /* ================= 渲染 ================= */
    function render(){
        $('title').innerText=state.config.title||'导航站点';
        $('footer').innerHTML=(state.config.footerText||'')
            .replace('{CURRENT_YEAR}',new Date().getFullYear());

        const box=$('groups'); box.innerHTML='';
        state.categoryList.forEach(cat=>{
            const items=state.data.filter(d=>d.categoryId===cat.id);

            const g=document.createElement('div');
            g.className='group';

            g.innerHTML=`
<div class="group-header" draggable="true" data-id="${cat.id}">
  <div class="group-title">${cat.name} (${items.length})</div>
  <button class="btn btn-outline" onclick="addItem(${cat.id})">+ 站点</button>
</div>
<div class="cards" data-id="${cat.id}"></div>
`;
            const header=g.querySelector('.group-header');
            const cards=g.querySelector('.cards');

            /* 分组拖拽 */
            header.ondragstart=e=>{
                header.classList.add('dragging');
                e.dataTransfer.setData('text/plain',cat.id);
            };
            header.ondragend=e=>{
                header.classList.remove('dragging');
                const ids=[...document.querySelectorAll('.group-header')]
                    .map(h=>+h.dataset.id);
                state.categoryList.sort((a,b)=>ids.indexOf(a.id)-ids.indexOf(b.id));
                save();
            };
            header.ondragover=e=>{
                e.preventDefault();
                const dragging=document.querySelector('.group-header.dragging');
                if(dragging && dragging!==header){
                    header.parentNode.before(dragging.parentNode);
                }
            };

            /* 卡片 */
            items.sort((a,b)=>a.weight-b.weight).forEach(i=>{
                const c=document.createElement('div');
                c.className='card'; c.draggable=true; c.dataset.id=i.id;
                c.innerHTML=`
<div class="ico"><img src="${i.logoUrl||autoLogo(i.url)}"></div>
<div class="info">
  <h3>${i.name}</h3>
  <p>${i.url}</p>
</div>
`;
                /* 卡片拖拽 */
                c.ondragstart=e=>{
                    c.classList.add('dragging');
                    e.dataTransfer.setData('text/plain',i.id);
                };
                c.ondragend=e=>{
                    c.classList.remove('dragging');
                    document.querySelectorAll('.cards').forEach(box=>{
                        const cid=+box.dataset.id;
                        [...box.children].forEach((el,idx)=>{
                            const item=state.data.find(d=>d.id==el.dataset.id);
                            if(item){
                                item.categoryId=cid;
                                item.weight=idx+1;
                            }
                        });
                    });
                    save();
                };
                cards.appendChild(c);
            });

            /* 跨组接收 */
            cards.ondragover=e=>{
                e.preventDefault();
                cards.classList.add('drag-over');
                const dragging=document.querySelector('.card.dragging');
                if(dragging && dragging.parentNode===cards){
                    const after=[...cards.children]
                        .find(el=>e.clientY<el.getBoundingClientRect().top+el.offsetHeight/2);
                    cards.insertBefore(dragging,after||null);
                }
            };
            cards.ondragleave=()=>cards.classList.remove('drag-over');
            cards.ondrop=()=>cards.classList.remove('drag-over');

            box.appendChild(g);
        });
    }

    /* ================= 新增 ================= */
    $('addGroup').onclick=()=>{
        const name=prompt('分组名称');
        if(!name) return;
        state.categoryList.push({id:Date.now(),name,desc:name,weight:state.categoryList.length});
        save();render();
    };

    async function addItem(cid){
        let url='';
        try{url=await navigator.clipboard.readText()}catch{}
        if(!url.startsWith('http')) url=prompt('站点 URL');
        if(!url) return;
        const name=new URL(url).hostname.replace('www.','');
        state.data.push({
            id:Date.now(),
            categoryId:cid,
            name,desc:name,url,
            logoUrl:autoLogo(url),
            weight:state.data.filter(i=>i.categoryId===cid).length+1,
            date:new Date().toISOString()
        });
        save();render();
    }

    /* ================= 搜索 ================= */
    $('search').oninput=e=>{
        const q=e.target.value.toLowerCase();
        document.querySelectorAll('.group').forEach(g=>{
            let hit=false;
            g.querySelectorAll('.card').forEach(c=>{
                const ok=c.innerText.toLowerCase().includes(q);
                c.classList.toggle('hidden',!ok);
                if(ok) hit=true;
            });
            g.classList.toggle('hidden',!hit);
        });
    };

    /* ================= 快捷键 ================= */
    document.addEventListener('keydown',e=>{
        if(e.key==='/'||((e.ctrlKey||e.metaKey)&&e.key==='k')){
            e.preventDefault();$('search').focus();
        }
        if(e.key==='Escape'){
            $('search').value='';
            $('search').dispatchEvent(new Event('input'));
        }
    });

    /* ================= 剪贴板一键建站 ================= */
    document.addEventListener('paste',e=>{
        const text=(e.clipboardData||window.clipboardData).getData('text');
        if(!/^https?:\/\//.test(text)) return;
        if(!state.categoryList.length) return;
        const url=new URL(text);
        const cat=state.categoryList[0];
        state.data.push({
            id:Date.now(),
            categoryId:cat.id,
            name:url.hostname.replace('www.',''),
            desc:'',
            url:text,
            logoUrl:autoLogo(text),
            weight:state.data.filter(i=>i.categoryId===cat.id).length+1,
            date:new Date().toISOString()
        });
        save();render();
    });

    /* ================= 启动 ================= */
    init();
</script>
</body>
</html>